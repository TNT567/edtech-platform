# 🚀 极致个性化练习系统升级计划

## 1. 🧠 智能出题策略引擎 (Core Engine)
我们将废弃原有的 `PracticeController` 简单逻辑，新建 `PracticeStrategyService` 作为核心调度器。

### 1.1 策略权重算法
每次请求题目时，按以下优先级动态路由：
1.  **纠错专项模式 (Drill Mode)**: 优先级最高。如果 Redis 中存在 `student:{id}:drill_mode` 标记，强制进入该模式，直到连续答对 2 题。
2.  **加权随机选择**:
    - **40% 高频错题**: 从 `ZSet student:{id}:wrong_freq` (Score高者优先) 取 Top 10，随机选 1。
    - **30% 薄弱击破**: 从 `ZSet student:{id}:weak_kps` (Score=1-掌握度) 取 Top 5，随机选 1。
    - **15% 记忆唤醒**: 从 `ZSet student:{id}:review_due` (Score=下次复习时间) 取 Score < 当前时间的知识点。
    - **10% 进阶拓展**: 从 `Hash student:{id}:mastery` 筛选掌握度 > 0.8 的知识点。
    - **5% 探索新知**: 基于知识图谱（MySQL）查找前驱已掌握的后继节点。

### 1.2 Redis 数据结构设计
- **Mastery Hash**: `student:1:mastery` -> `{ "kp_101": 0.85, "kp_102": 0.4 }`
- **Weak Points ZSet**: `student:1:weak_kps` -> `kp_102` (score: 0.6)
- **Mistake Freq ZSet**: `student:1:wrong_freq` -> `kp_102` (score: 5)
- **Review Schedule ZSet**: `student:1:review_due` -> `kp_101` (score: 1718900000)
- **Common Mistakes Hash**: `student:1:common_mistakes` -> `{ "kp_102": "常混淆正弦与余弦" }`

## 2. 🤖 AI Prompt 动态注入 (Context-Aware)
升级 `ContentGenerationService`，在调用 Qwen-Plus 时注入极其详细的上下文：
- **Prompt 模板**: 严格执行您提供的“20年教龄特级教师”人设。
- **变量注入**:
  - `{kp_name}`: 知识点名称
  - `{probability}`: Redis 中的 BKT 实时概率
  - `{common_mistakes}`: 从 Redis Hash 中获取的历史误区
  - `{last_wrong}`: 从 MySQL/Redis List 获取的最近一次错误选项
  - `{days_since_review}`: 计算 `(Now - LastPracticeTime)`

## 3. 🔁 闭环反馈与数据流
### 3.1 提交答案 (`/api/practice/submit`)
- **同步操作 (Redis)**:
  1.  调用 BKT 更新掌握度。
  2.  计算 SM-2 间隔，更新 `review_due` ZSet。
  3.  若是错题：更新 `wrong_freq` (+1)，设置 `drill_mode` 标记，记录 `common_mistakes`。
  4.  若是对题：检查是否在 Drill Mode，更新连续正确计数，若 >=2 则移除标记。
  5.  **游戏化判定**: 若掌握度 > 0.9 且 Redis List 最近5条全为 1 -> 触发“金牌掌握”。
- **异步操作 (RabbitMQ)**:
  - 发送消息 `PracticeLogMessage`。
  - 消费者：落库 MySQL `student_exercise_log`，更新错题本详情，生成周报数据。

## 4. 🎨 前端体验重构
- **练习页 (`PracticePage`)**:
  - 顶部增加 **"当前策略 Badge"** (e.g., 🔴 高频错题重练 / 🔵 艾宾浩斯复习)。
  - 错题后不直接跳下一题，而是弹出 **AI 深度解析 Modal**，包含“开始纠错专项”引导按钮。
- **雷达图 (`KnowledgeRadarChart`)**:
  - 增加点击事件，点击某个维度直接跳转到该知识点的专项练习接口。
  - 增加 **金边特效** (CSS Glow) 用于显示已完全掌握的维度。

## 执行计划
1.  **基础设施**: 添加 `RedisUtils` 工具类封装 ZSet/Hash 操作；添加 RabbitMQ 配置。
2.  **核心服务**: 实现 `SpacedRepetitionService` (SM-2) 和 `PracticeStrategyService`。
3.  **接口升级**: 修改 `PracticeController` 适配新逻辑。
4.  **AI 升级**: 更新 `ContentGenerationService` Prompt 模板。
5.  **前端开发**: 改造练习页和雷达图组件。
